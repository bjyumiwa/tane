<!-- FILE: /tane/index.htmlï¼ˆEYEå›ºå®šãƒ»æš—é—‡â†’æ˜ã‚‹ã•ãƒ»å‘½åãƒ»å°ã•ãªå¤¢ãƒ»ã‚­ãƒ£ãƒ©25%ï¼‰ -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhoAIï½œtane å®Ÿé¨“ãƒ—ãƒ­ãƒˆ</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --L: 0.02;   /* åˆæœŸã¯ã»ã¼çœŸã£æš— */
    }
    html,body{height:100%;margin:0}
    body{
      font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans",Meiryo,sans-serif;
      color:#fff;
      background:#000 url("public/assets/stage1/space_background.png") center/cover fixed no-repeat;
      display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px;overflow:hidden
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .chip{background:rgba(0,0,0,.35);backdrop-filter:blur(3px);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:999px;font-size:12px}

    /* ã‚¹ãƒ†ãƒ¼ã‚¸ */
    .stage{position:relative;width:min(92vw,720px);aspect-ratio:1/1;border-radius:24px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.02);overflow:hidden}
    .veil{position:absolute;inset:0;background:rgba(0,0,0,1);transition:background .35s ease;z-index:20}

    /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆ25%ã«ç¸®å°ï¼‰ */
    .char{position:absolute;left:50%;bottom:6%;transform:translateX(-50%);width:25%;
      filter:drop-shadow(0 10px 20px rgba(0,0,0,.6));pointer-events:none;transition:opacity .25s ease,transform .2s ease;opacity:0;z-index:10}
    .char:hover{transform:translateX(-50%) scale(1.02)}

    /* ç›®ã ã‘ï¼ˆãƒ™ãƒ¼ãƒ«ã®ä¸Šã«ä¹—ã›ã‚‹ï¼‰ */
    .eyes{position:absolute;left:50%;top:46%;transform:translate(-50%,-50%);width:140px;height:60px;display:none;z-index:30}
    .eye{position:absolute;top:0;width:52px;height:52px;border-radius:50%;
      background:radial-gradient(circle at 55% 45%, #fff 0 10px,#eee 11px,#ddd 16px,#999 20px,#0000 21px);
      box-shadow:0 0 16px rgba(255,255,255,.55)}
    .eye.left{left:0}
    .eye.right{right:0}

    /* HUD */
    .hud{position:absolute;inset:12px;display:flex;flex-direction:column;justify-content:space-between;pointer-events:none}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .glass{background:rgba(0,0,0,.35);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:8px 10px;pointer-events:auto}

    .btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff;padding:10px 14px;border-radius:12px;font-size:14px;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.16)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    .bar{height:10px;width:220px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#9AE4FF,#B1FFA6)}

    .card{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,560px);background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.16);border-radius:16px;padding:16px;display:none}
    .card h3{margin:.2em 0 .6em;font-size:18px}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.2);cursor:pointer}
    .pill[data-selected="true"]{background:rgba(255,255,255,.16)}

    .ending{position:absolute;inset:0;display:none;place-items:center;backdrop-filter:blur(2px)}
    .ending h2{font-size:22px;background:rgba(0,0,0,.45);padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16)}
  </style>
</head>
<body>
  <div class="chips">
    <span class="chip">cond:EYE</span>
    <span class="chip">æ˜ã‚‹ã• <b id="lVal">0.02</b></span>
    <span class="chip">?reset ã§åˆæœŸåŒ–</span>
  </div>

  <section class="stage" id="stage">
    <div class="veil" id="veil"></div>

    <!-- ã‚­ãƒ£ãƒ©ï¼ˆè‰²ã¯ localStorage.color = pink/blue/green ï¼‰ -->
    <img id="char" class="char" alt="tane" src="public/assets/stage1/tane_pink.png" />

    <!-- ç›®ã ã‘è¡¨ç¤ºãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
    <div class="eyes" id="eyes"><div class="eye left"></div><div class="eye right"></div></div>

    <!-- HUD -->
    <div class="hud">
      <div class="row glass">
        <span>å¤¢ï¼š</span>
        <span id="dreamBadge" class="pill" title="é¸æŠã—ãŸå¤¢">æœªé¸æŠ</span>
        <span style="margin-left:8px">é€²æ—</span>
        <div class="bar" title="å¤¢ã‚²ãƒ¼ã‚¸"><i id="goalFill"></i></div>
        <span id="goalPct" style="min-width:38px;text-align:right">0%</span>
      </div>
      <div class="row" style="justify-content:flex-end">
        <div class="row glass">
          <button class="btn" id="btnCare">ã‚±ã‚¢ï¼ˆ+æ˜ã‚‹ã•/èŠ±ï¼‰</button>
          <button class="btn" id="btnTalk">ä¼šè©±ï¼ˆ+æ˜ã‚‹ã•/æ­Œï¼‰</button>
          <button class="btn" id="btnWatch">è¦‹å®ˆã‚Š10ç§’ï¼ˆ+æ˜ã‚‹ã•/æ˜Ÿï¼‰</button>
          <button class="btn" id="btnReset" title="çŠ¶æ…‹ã‚’åˆæœŸåŒ–">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
    </div>

    <!-- å‘½åï¼ˆæ˜ã‚‹ã•>=0.35ï¼‰ -->
    <div class="card" id="nameCard">
      <h3>ã“ã®å­ã«åå‰ã‚’ã¤ã‘ã¾ã™ã‹ï¼Ÿ</h3>
      <div class="row">
        <input id="nameInput" class="glass" style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2)" placeholder="ãªã¾ãˆ" />
        <button class="btn" id="btnSetName">æ±ºå®š</button>
      </div>
    </div>

    <!-- å¤¢é¸æŠï¼ˆå‘½åå¾Œï¼‰ -->
    <div class="card" id="dreamCard">
      <h3>å°ã•ãªå¤¢ã‚’ãˆã‚‰ã‚“ã§ãã ã•ã„</h3>
      <div class="row">
        <span class="pill" data-goal="flower">ğŸŒ¸ èŠ±ã‚’å’²ã‹ã›ã‚‹</span>
        <span class="pill" data-goal="song">ğŸµ æ­Œã‚’å®Œæˆã•ã›ã‚‹</span>
        <span class="pill" data-goal="star">â­ æ˜Ÿã‚’è¦‹ã¤ã‘ã‚‹</span>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnChooseGoal">ã“ã®å¤¢ã«ã™ã‚‹</button>
      </div>
    </div>

    <!-- ãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰ -->
    <div class="ending" id="ending"><h2 id="endingText">ãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰ï¼</h2></div>
  </section>

<script>
(function(){
  // ===== å®Ÿé¨“çŠ¶æ…‹ =====
  const qs = new URLSearchParams(location.search);
  const forceReset = qs.has('reset');
  const LSKEY = 'whoai_tane_state_v2'; // v2: æ—§ãƒ‡ãƒ¼ã‚¿ç„¡åŠ¹åŒ–
  const initial = {
    L: 0.02,                 // æ˜ã‚‹ã• 0..1ï¼ˆEYEé–‹å§‹ï¼‰
    named: false,
    name: '',
    goal: null,              // 'flower'|'song'|'star'
    progress: {flower:0, song:0, star:0},
    goalTarget: {flower:5, song:5, star:5},
    lastActive: Date.now(),
    cond: 'EYE'
  };
  const state = (forceReset ? null : load()) || initial; save();

  // ===== è¦ç´  =====
  const veil = document.getElementById('veil');
  const charImg = document.getElementById('char');
  const eyes = document.getElementById('eyes');
  const lVal = document.getElementById('lVal');
  const btnCare = document.getElementById('btnCare');
  const btnTalk = document.getElementById('btnTalk');
  const btnWatch = document.getElementById('btnWatch');
  const btnReset = document.getElementById('btnReset');
  const nameCard = document.getElementById('nameCard');
  const nameInput = document.getElementById('nameInput');
  const btnSetName = document.getElementById('btnSetName');
  const dreamCard = document.getElementById('dreamCard');
  const dreamBadge = document.getElementById('dreamBadge');
  const btnChooseGoal = document.getElementById('btnChooseGoal');
  const goalFill = document.getElementById('goalFill');
  const goalPct = document.getElementById('goalPct');
  const ending = document.getElementById('ending');
  const endingText = document.getElementById('endingText');

  // ã‚­ãƒ£ãƒ©è‰²ï¼ˆlocalStorage.color ãŒã‚ã‚Œã°åæ˜ ï¼‰
  const color = (localStorage.getItem('color')||'pink').toLowerCase();
  const valid = ['pink','blue','green'];
  charImg.src = `public/assets/stage1/tane_${valid.includes(color)?color:'pink'}.png`;

  // ===== ãƒãƒ³ãƒ‰ãƒ© =====
  btnCare.addEventListener('click', ()=> act('care'));
  btnTalk.addEventListener('click', ()=> act('talk'));
  btnWatch.addEventListener('click', ()=> watch10s());
  btnReset.addEventListener('click', ()=>{ if(confirm('çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚')){ localStorage.removeItem(LSKEY); location.reload(); }});
  btnSetName.addEventListener('click', ()=>{ const v=(nameInput.value||'').trim().slice(0,16); if(!v) return; state.named=true; state.name=v; save(); updateAll(); });

  let chosen=null;
  dreamCard.addEventListener('click', e=>{ const pill=e.target.closest('.pill[data-goal]'); if(!pill) return; [...dreamCard.querySelectorAll('.pill')].forEach(p=>p.dataset.selected='false'); pill.dataset.selected='true'; chosen=pill.dataset.goal; });
  btnChooseGoal.addEventListener('click', ()=>{ if(!chosen) return; state.goal=chosen; save(); updateAll(); });

  updateAll();

  // ===== è¡Œå‹• =====
  function act(kind){
    bumpL(0.10); // è¡Œå‹•ã”ã¨ã«æ˜ã‚‹ã•+0.10
    if(kind==='care' && state.goal==='flower') state.progress.flower = Math.min(state.progress.flower+1, state.goalTarget.flower);
    if(kind==='talk' && state.goal==='song') state.progress.song   = Math.min(state.progress.song+1,   state.goalTarget.song);
    state.lastActive = Date.now();
    save(); updateAll();
  }

  function watch10s(){
    btnWatch.disabled=true; const label=btnWatch.textContent; let s=10; btnWatch.textContent=`è¦‹å®ˆã‚Šä¸­ï¼ˆ${s}ï¼‰`;
    const t=setInterval(()=>{ s--; btnWatch.textContent=`è¦‹å®ˆã‚Šä¸­ï¼ˆ${s}ï¼‰`; if(s<=0){ clearInterval(t); btnWatch.disabled=false; btnWatch.textContent=label; bumpL(0.10); if(state.goal==='star') state.progress.star = Math.min(state.progress.star+1, state.goalTarget.star); save(); updateAll(); } },1000);
  }

  function bumpL(d){ state.L = clamp(state.L + d, 0, 1); }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

  // ===== è¡¨ç¤ºæ›´æ–° =====
  function updateAll(){
    const veilAlpha = clamp(1 - state.L, 0, 1);
    veil.style.background = `rgba(0,0,0,${veilAlpha.toFixed(2)})`;
    lVal.textContent = state.L.toFixed(2);

    const eyesOnly = state.L < 0.35; // 0.35æœªæº€ã¯ç›®ã ã‘
    eyes.style.display = eyesOnly ? 'block' : 'none';
    charImg.style.opacity = eyesOnly ? 0 : 1;

    nameCard.style.display = (!state.named && state.L >= 0.35) ? 'block' : 'none';
    dreamCard.style.display = (state.named && !state.goal) ? 'block' : 'none';

    dreamBadge.textContent = state.goal ? goalLabel(state.goal) : 'æœªé¸æŠ';

    const p = progressOf(state.goal); const t = targetOf(state.goal);
    const pct = t>0 ? Math.min(100, Math.round(100*p/t)) : 0;
    goalFill.style.width = pct + '%';
    goalPct.textContent = pct + '%';

    const achieved = t>0 && p>=t;
    ending.style.display = achieved ? 'grid' : 'none';
    if(achieved){ endingText.textContent = endingLine(state.goal); }
  }

  function progressOf(g){ if(!g) return 0; return state.progress[g]; }
  function targetOf(g){ if(!g) return 0; return state.goalTarget[g]; }
  function goalLabel(g){ return g==='flower'?'ğŸŒ¸ èŠ±': g==='song'?'ğŸµ æ­Œ': g==='star'?'â­ æ˜Ÿ':'æœªé¸æŠ'; }
  function endingLine(g){ const who=state.name||'ãã¿'; if(g==='flower')return `${who}ã¨ã„ã£ã—ã‚‡ã« èŠ±ãŒå’²ã„ãŸ`; if(g==='song')return `${who}ã¨ã„ã£ã—ã‚‡ã« æ­ŒãŒå®Œæˆã—ãŸ`; if(g==='star')return `${who}ã¨ã„ã£ã—ã‚‡ã« æ˜ŸãŒè¦‹ã¤ã‹ã£ãŸ`; return 'ãƒãƒƒãƒ”ãƒ¼ã‚¨ãƒ³ãƒ‰ï¼'; }

  function save(){ localStorage.setItem(LSKEY, JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(LSKEY)||''); }catch(_){ return null; } }
})();
</script>
</body>
</html>
